version: '3'

dotenv:
  - .env

tasks:

  build:
    cmds:
      - docker build --pull --rm -f ./api.Dockerfile -t ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME1}:latest .
      - docker build --pull --rm -f ./info.Dockerfile -t ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME2}:latest .
      - docker build --pull --rm -f ./login.Dockerfile -t ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME3}:latest .
      - docker build --pull --rm -f ./root.Dockerfile -t ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME4}:latest .

  push:
    cmds:
      - docker tag ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME1}:latest ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME1}:${APP_IMAGE_TAG}
      - docker tag ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME2}:latest ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME2}:${APP_IMAGE_TAG}
      - docker tag ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME3}:latest ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME3}:${APP_IMAGE_TAG}
      - docker tag ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME4}:latest ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME4}:${APP_IMAGE_TAG}
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME1}:${APP_IMAGE_TAG}
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME2}:${APP_IMAGE_TAG}
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME3}:${APP_IMAGE_TAG}
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME4}:${APP_IMAGE_TAG}
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME1}:latest
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME2}:latest
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME3}:latest
      - docker push ${APP_IMAGE_OWNER}/${APP_IMAGE_NAME4}:latest

  deploy:
    cmds: 
      - kubectl apply -f ./deployments/k8s/config-env-api.yaml
      - kubectl apply -f ./deployments/k8s/config-env-info.yaml
      - kubectl apply -f ./deployments/k8s/config-env-login.yaml
      - kubectl apply -f ./deployments/k8s/config-env-root.yaml
      - kubectl apply -f ./deployments/k8s/api-deployment.yaml
      - kubectl apply -f ./deployments/k8s/info-deployment.yaml
      - kubectl apply -f ./deployments/k8s/login-deployment.yaml
      - kubectl apply -f ./deployments/k8s/root-deployment.yaml
      - kubectl apply -f ./services/api-services.yaml 
      - kubectl apply -f ./services/info-services.yaml 
      - kubectl apply -f ./services/login-services.yaml 
      - kubectl apply -f ./services/root-services.yaml 
      - kubectl apply -f ./ingress/ingress.yaml
  
  uninstall:
    cmds:
      - kubectl delete -f ./deployments/k8s/config-env-api.yaml
      - kubectl delete -f ./deployments/k8s/config-env-info.yaml
      - kubectl delete -f ./deployments/k8s/config-env-login.yaml
      - kubectl delete -f ./deployments/k8s/config-env-root.yaml
      - kubectl delete -f ./deployments/k8s/api-deployment.yaml
      - kubectl delete -f ./deployments/k8s/info-deployment.yaml
      - kubectl delete -f ./deployments/k8s/login-deployment.yaml
      - kubectl delete -f ./deployments/k8s/root-deployment.yaml
      - kubectl delete -f ./services/api-services.yaml 
      - kubectl delete -f ./services/info-services.yaml 
      - kubectl delete -f ./services/login-services.yaml 
      - kubectl delete -f ./services/root-services.yaml 
      - kubectl delete -f ./ingress/ingress.yaml

  release:
    cmds:
      - task: build
      - task: push
      - task: deploy